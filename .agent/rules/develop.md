---
description: 開発サイクルの基本ルール（ブランチ管理、コミット、検証、マージ）
trigger: always_on
---

# 開発ルール

このドキュメントは、エージェントが開発作業を行う際の基本規約を定義します。

## 1. 修正の開始
1.  **Issue発行**: 修正を開始する前に、必ずGitHubでIssueを発行すること。
2.  **概要の記載**: Issueには作業内容の要約を記載すること。
3.  **ブランチ作成**: 最新の `origin/develop` からブランチを切り出すこと。
    - ブランチ名形式: `feature/issue-[Issue番号]`
    - **Exception (Hotfix)**: 緊急修正の場合は `origin/main` から `hotfix/issue-[Issue番号]` を作成する。
4.  **CLIコマンドの安全性**: `gh` コマンド等で日本語や特殊文字（バッククォート、改行）を含む引数を渡す際は、シェルの解釈エラーを防ぐために適切なエスケープや引用符の使用を確認すること。
    - **必須**: IssueやPRの本文（body）など、日本語や特殊文字を含む長文を作成する場合は、必ずテキストファイルを作成し、`--body-file` オプションを使用して読み込ませること。直接の引数渡しは禁止とする。

## 2. 開発とコーディング規約
1.  **コメント**: コード内のコメントは日本語で記述すること。
2.  **ログ**: 実装する際には適宜[ログ](file:///c:/Workspace/life_counter/lib/shared/utils/app_logger.dart)を埋め込むこと。
3.  **テストコードの維持**: 新しい機能を実装やリファクタリングをする際には、テストコードの作成及び既存テストコードのメンテナンスを行うこと。
4.  **フォーマット**: コミット前には必ず `dart format .` を実行し、コードを整形すること。
5.  **定数の利用 (Magic Number禁止)**: 数値や文字列リテラルを直接コードに記述せず、`constants.dart` 等に定数として定義して利用すること。
6.  **状態管理の統一**: 原則として `flutter_riverpod` を使用し、UIウィジェット内の `setState` はアニメーション制御など最小限に留めること。

## 3. コミットルール
1.  **コミット単位 (Atomic)**: 機能の追加、バグ修正、リファクタリング等はそれぞれ別のコミット/PRに分け、意味のある最小単位で行うこと。
2.  **コミットメッセージ**: `type: #[Issue番号] 概要` の形式で記述すること。
    - 例: `feat: #111 自動テストの導入`
    - **コミットタイプ一覧**:
        - `feat`: 新機能
        - `fix`: バグ修正
        - `docs`: ドキュメントのみの変更
        - `style`: コードの動作に影響しない変更（空白、フォーマットなど）
        - `refactor`: バグ修正も機能追加も行わないコードの変更（リファクタリング）
        - `perf`: パフォーマンスを向上させる変更
        - `test`: テストの追加や既存テストの修正
        - `chore`: その他（ビルドプロセスやツールの変更など）

## 4. 品質保証 (必須)
コードを提出または編集する際は、以下のチェックを必ずローカルで実施し、パスすることを確認すること。
- `dart format .` (プロジェクト全体のフォーマット適用)
- `flutter analyze` (静的解析)
- `flutter test` (全ユニット/ウィジェットテストの実行)

## 5. 合流 (developへ)
1.  **PR作成**: 作業完了後、`origin/develop` へプルリクエストを作成すること。
2.  **マージ (CI待機)**: `gh pr merge --auto --merge` を実行し、CIチェック（GitHub Actions等）がパスした後に自動的にマージされるようにすること。
    - **Note**: `--admin` などによる強制マージは原則禁止とする。
3.  **ブランチの削除**: マージ後は速やかにブランチを削除すること（`--delete-branch` 推奨）。
4.  **Issue管理**: `develop` へのマージ完了後、対応するIssueをクローズすること。

## 6. 同期
1.  マージ後は最新の `origin/develop` を `fetch` し、ローカルブランチに `pull` して最新状態を保つこと。
2.  **mainとの同期 (Backport)**: `main` ブランチが更新（リリース/Hotfix）された後は、`origin/main` を fetch し、ローカルの `develop` へマージして `origin/develop` へプッシュすること（PR不要）。
    - Note: コンフリクトが発生した場合は、ローカルで解消してからプッシュすること。

## 7. リリース
1.  `main` ブランチへのリリースを行う際は、[リリース手順](file:///c:/Workspace/life_counter/.agent/rules/release.md) に記載された手順に従うこと。

## 8. 安全管理
1.  **ブランチ確認**: コマンド実行前（特に `git push`, `gh pr create`）には必ず `git branch` 等で現在作業中のブランチを確認すること。
2.  **main保護**: `main` ブランチへの直接コミットおよびマージは原則禁止とする。
    - `main` へプルリクエストを作成できるのは `develop` および `hotfix` ブランチのみとする。
    - `feature` ブランチから `main` へのPR作成は禁止する。
